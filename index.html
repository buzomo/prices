<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ·ï¸</text></svg>"
    />
    <title>å•†å“ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  </head>
  <body>
    <div class="header-card">
      <div class="header-title">å•†å“ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
      <div class="search-area">
        <input type="text" id="searchInput" placeholder="å•†å“åã§æ¤œç´¢..." />
        <div id="searchResults" class="search-results"></div>
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="productName" placeholder="å•†å“å" required />
      <input type="text" id="manufacturer" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼" required />
      <input type="text" id="store" placeholder="åº—å" required />
      <input type="text" id="price" placeholder="ä¾¡æ ¼" required />
      <button class="add-button" onclick="addProduct()">è¿½åŠ </button>
    </div>

    <table>
      <thead>
        <tr>
          <th>å•†å“å</th>
          <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
          <th>åº—</th>
          <th>ä¾¡æ ¼</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>å•†å“æƒ…å ±ã®ç·¨é›†</h2>
        <div class="input-area">
          <input type="text" id="editProductName" placeholder="å•†å“å" required />
          <input type="text" id="editManufacturer" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼" required />
          <input type="text" id="editStore" placeholder="åº—å" required />
          <input type="text" id="editPrice" placeholder="ä¾¡æ ¼" required />
          <button class="update-button" onclick="updateProduct()">æ›´æ–°</button>
          <button class="delete-button" onclick="deleteProduct()">å‰Šé™¤</button>
        </div>
      </div>
    </div>

    <div id="toast"></div>

    <script>
      let products = [];
      let currentRequest = null;
      let retryCount = 0;
      const maxRetries = 3;
      let currentEditIndex = null;

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’æ”¹å–„
      async function loadProducts() {
        try {
          const response = await fetch('https://raw.githubusercontent.com/buzomo/cash-data/refs/heads/main/prices.json');
          
          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã¾ãŸã¯ä¸æ­£ãªå ´åˆã¯ç©ºã®é…åˆ—ã‚’ä½¿ç”¨
          if (!response.ok) {
            console.log('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚');
            products = [];
            return;
          }
          
          const text = await response.text();
          
          // ç©ºã®å¿œç­”ã‚„ç„¡åŠ¹ãªJSONã®å ´åˆã¯ç©ºã®é…åˆ—ã‚’ä½¿ç”¨
          if (!text || text.trim() === '') {
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã—ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚');
            products = [];
            return;
          }
          
          // JSONã¨ã—ã¦è§£æ
          try {
            products = JSON.parse(text);
            console.log('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸ:', products.length, 'ä»¶');
          } catch (parseError) {
            console.error('JSONã®è§£æã‚¨ãƒ©ãƒ¼:', parseError);
            // å•é¡ŒãŒã‚ã‚Œã°åˆæœŸåŒ–
            products = [];
            showToast("ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚æ–°è¦ã«ä½œæˆã—ã¾ã™ã€‚");
          }
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          products = [];
          showToast("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–°è¦ã«ä½œæˆã—ã¾ã™ã€‚");
        } finally {
          updateTable();
        }
      }

      // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      loadProducts();

      function formatPrice(price) {
        return new Intl.NumberFormat("ja-JP", {
          style: "currency",
          currency: "JPY",
        }).format(price);
      }

      function updateTable() {
        const tbody = document.getElementById("productTable");
        tbody.innerHTML = "";

        if (products.length === 0) {
          const row = tbody.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 4;
          cell.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
          cell.style.textAlign = "center";
          cell.style.padding = "20px";
          cell.style.color = "#666";
          return;
        }

        products
          .sort((a, b) => a.productName.localeCompare(b.productName, 'ja'))
          .forEach((product, index) => {
            const row = tbody.insertRow();
            row.insertCell().textContent = product.productName;
            row.insertCell().textContent = product.manufacturer;
            row.insertCell().textContent = product.store;
            row.insertCell().textContent = formatPrice(product.price);
            row.onclick = () => openModal(index);
          });
      }

      async function pushToGitHub(content) {
        const controller = new AbortController();
        currentRequest = controller;

        try {
          const sha = await getFileSHA();
          const formattedContent = JSON.stringify(content, null, 2);
          const response = await fetch(
            'https://api.github.com/repos/buzomo/cash-data/contents/prices.json',
            {
              method: sha ? 'PUT' : 'PUT', // å¸¸ã«PUTã‚’ä½¿ç”¨ï¼ˆæ–°è¦ä½œæˆã‚‚æ›´æ–°ã‚‚ï¼‰
              headers: {
                'Authorization': `token ${getLocalStorageToken('gh_token')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Auto-save ${new Date().toISOString()}`,
                content: base64EncodeUnicode(formattedContent),
                sha: sha || undefined // SHAãŒãªã„å ´åˆã¯çœç•¥ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼‰
              }),
              signal: controller.signal
            }
          );

          if (response.status === 409) {
            throw new Error('sha mismatch');
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message);
          }

          retryCount = 0;
          return true;
        } catch (error) {
          if (error.name === 'AbortError') return;
          console.error('GitHubä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        } finally {
          currentRequest = null;
        }
      }

      async function autoSave(content) {
        try {
          await pushToGitHub(content);
          return true;
        } catch (error) {
          if (error.message === 'sha mismatch' && retryCount < maxRetries) {
            retryCount++;
            return autoSave(content);
          }
          return false;
        }
      }

      function addProduct() {
        const productName = document.getElementById("productName").value.trim();
        const manufacturer = document.getElementById("manufacturer").value.trim();
        const store = document.getElementById("store").value.trim();
        let price = document.getElementById("price").value.replace(/[,Â¥]/g, "").trim();

        if (productName && manufacturer && store && !isNaN(parseFloat(price))) {
          price = parseFloat(price);
          products.push({ productName, manufacturer, store, price });
          updateTable();
          document.getElementById("productName").value = "";
          document.getElementById("manufacturer").value = "";
          document.getElementById("store").value = "";
          document.getElementById("price").value = "";
          autoSave(products).then(success => {
            if (success) {
              showToast("ãƒ‡ãƒ¼ã‚¿ãŒGitHubã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
            } else {
              showToast("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
          });
        } else {
          alert("æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
        }
      }

      function openModal(index) {
        currentEditIndex = index;
        const product = products[index];
        document.getElementById("editProductName").value = product.productName;
        document.getElementById("editManufacturer").value = product.manufacturer;
        document.getElementById("editStore").value = product.store;
        document.getElementById("editPrice").value = product.price;
        document.getElementById("editModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function updateProduct() {
        const productName = document.getElementById("editProductName").value.trim();
        const manufacturer = document.getElementById("editManufacturer").value.trim();
        const store = document.getElementById("editStore").value.trim();
        let price = document.getElementById("editPrice").value.replace(/[,Â¥]/g, "").trim();

        if (productName && manufacturer && store && !isNaN(parseFloat(price))) {
          price = parseFloat(price);
          products[currentEditIndex] = { productName, manufacturer, store, price };
          updateTable();
          closeModal();
          autoSave(products).then(success => {
            if (success) {
              showToast("ãƒ‡ãƒ¼ã‚¿ãŒGitHubã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
            } else {
              showToast("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
          });
        } else {
          alert("æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
        }
      }

      function deleteProduct() {
        products.splice(currentEditIndex, 1);
        updateTable();
        closeModal();
        autoSave(products).then(success => {
          if (success) {
            showToast("ãƒ‡ãƒ¼ã‚¿ãŒGitHubã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
          } else {
            showToast("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        });
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 2000);
      }

      function getLocalStorageToken(key) {
        const token = localStorage.getItem(key);
        if (!token) {
          console.warn('GitHubãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚');
        }
        return token || '';
      }

      function base64EncodeUnicode(str) {
        return btoa(unescape(encodeURIComponent(str)));
      }

      async function getFileSHA() {
        try {
          const response = await fetch('https://api.github.com/repos/buzomo/cash-data/contents/prices.json', {
            headers: {
              'Authorization': `token ${getLocalStorageToken('gh_token')}`
            }
          });
          
          if (!response.ok) {
            if (response.status === 404) {
              console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æ–°è¦ä½œæˆã—ã¾ã™ã€‚');
              return null; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯nullã‚’è¿”ã™
            }
            throw new Error(`GitHub APIã‚¨ãƒ©ãƒ¼: ${response.status}`);
          }
          
          const data = await response.json();
          return data.sha;
        } catch (error) {
          console.error('SHAå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          return null; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯nullã‚’è¿”ã™
        }
      }

      // ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒã®å®Ÿè£…
      document.getElementById("searchInput").addEventListener("input", function() {
        const searchTerm = this.value.toLowerCase().trim();
        const resultsContainer = document.getElementById("searchResults");
        
        // æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
        resultsContainer.innerHTML = "";
        
        if (searchTerm.length < 2) {
          resultsContainer.style.display = "none";
          return;
        }
        
        // å•†å“åã§æ¤œç´¢
        const matches = products.filter(product => 
          product.productName.toLowerCase().includes(searchTerm)
        );
        
        if (matches.length > 0) {
          resultsContainer.style.display = "block";
          
          // æœ€å¤§10ä»¶ã¾ã§è¡¨ç¤º
          matches.slice(0, 10).forEach(product => {
            const resultItem = document.createElement("div");
            resultItem.className = "result-item";
            resultItem.textContent = `${product.productName} (${product.manufacturer}) - ${formatPrice(product.price)}`;
            
            resultItem.addEventListener("click", function() {
              // æ¤œç´¢çµæœã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
              document.getElementById("searchInput").value = product.productName;
              resultsContainer.style.display = "none";
              
              // è©²å½“å•†å“ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
              const index = products.findIndex(p => 
                p.productName === product.productName && 
                p.manufacturer === product.manufacturer &&
                p.store === product.store
              );
              
              if (index !== -1) {
                const rows = document.getElementById("productTable").rows;
                
                // ä»¥å‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
                Array.from(rows).forEach(row => {
                  row.classList.remove("highlighted");
                });
                
                // è©²å½“è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (rows[index]) {
                  rows[index].classList.add("highlighted");
                  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                  rows[index].scrollIntoView({ behavior: "smooth", block: "center" });
                }
              }
            });
            
            resultsContainer.appendChild(resultItem);
          });
          
          if (matches.length > 10) {
            const moreResults = document.createElement("div");
            moreResults.className = "more-results";
            moreResults.textContent = `ä»– ${matches.length - 10} ä»¶ã®çµæœãŒã‚ã‚Šã¾ã™`;
            resultsContainer.appendChild(moreResults);
          }
        } else {
          resultsContainer.style.display = "block";
          const noResults = document.createElement("div");
          noResults.className = "no-results";
          noResults.textContent = "è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“";
          resultsContainer.appendChild(noResults);
        }
      });
      
      // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰çµæœã‚’éè¡¨ç¤º
      document.addEventListener("click", function(event) {
        const searchInput = document.getElementById("searchInput");
        const searchResults = document.getElementById("searchResults");
        
        if (event.target !== searchInput && !searchResults.contains(event.target)) {
          searchResults.style.display = "none";
        }
      });

      document.addEventListener("keydown", function (e) {
        if (e.altKey && e.key === "s") {
          e.preventDefault();

          const productsData = `let products = ${JSON.stringify(
            products,
            null,
            4
          )};`;

          navigator.clipboard
            .writeText(productsData)
            .then(() => {
              showToast(
                "æœ€æ–°ã® products ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"
              );
            })
            .catch((err) => {
              showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
            });
        }
      });
    </script>
  </body>
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f8fa;
    }

    .header-card {
      background-color: #e8f4f8;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
    }

    .header-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .search-area {
      position: relative;
      width: 100%;
    }

    #searchInput {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }

    .search-results {
      display: none;
      position: absolute;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }

    .result-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .result-item:hover {
      background-color: #f5f5f5;
    }

    .no-results, .more-results {
      padding: 10px;
      color: #777;
      font-style: italic;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e1e8ed;
    }

    th {
      background-color: #1e88e5;
      color: white;
    }

    tbody tr:hover {
      background-color: #f5f8fa;
      cursor: pointer;
    }

    .highlighted {
      background-color: #e3f2fd !important;
      animation: highlight 2s;
    }

    @keyframes highlight {
      0% { background-color: #bbdefb; }
      100% { background-color: #e3f2fd; }
    }

    .input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #e8f4f8;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .input-area input,
    .input-area button {
      flex: 1 1 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }

    .input-area button {
      background-color: #1e88e5;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .input-area button:hover {
      background-color: #1976d2;
    }

    @media (min-width: 600px) {
      .input-area input {
        flex: 1 1 calc(50% - 5px);
      }
      
      .input-area button {
        flex: 1 1 100%;
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .update-button {
      background-color: #4CAF50 !important;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
    }

    .update-button:hover {
      background-color: #45a049 !important;
    }

    .delete-button {
      background-color: #f44336 !important;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
    }

    .delete-button:hover {
      background-color: #e53935 !important;
    }

    #toast {
      visibility: hidden;
      width: 100%;
      max-width: 800px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 12px;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      font-size: 16px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</html>
